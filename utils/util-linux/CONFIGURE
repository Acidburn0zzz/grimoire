. "$GRIMOIRE/FUNCTIONS" &&

local OLD_SPELL_VERSION="" &&
spell_ok $SPELL && OLD_SPELL_VERSION="$(installed_version $SPELL)" &&

# util-linux 2.20 needs ttyX in /etc/inittab without /dev
# http://www.sourcemage.org/issues/110
message "${MESSAGE_COLOR}Checking sanity of /etc/inittab...${DEFAULT_COLOR}" &&

if grep -iq "/dev/tty" "$INSTALL_ROOT/etc/inittab"; then
  if is_version_less ${OLD_SPELL_VERSION} 2.20 && is_version_less 2.19.1 ${VERSION}; then
    message "${PROBLEM_COLOR}" &&
    message "WARNING: $INSTALL_ROOT/etc/inittab needs syntax update. You need to" &&
    message "replace all '/dev/tty*' lines to 'tty*' equivalents, e.g.:" &&
    message "${MESSAGE_COLOR}Before: tty1:linux:/sbin/agetty /dev/tty1 9600" &&
    message "After:  tty1:linux:/sbin/agetty tty1 9600${PROBLEM_COLOR}" &&
    message "Press 'n' to abort cast and do that manually by editing" &&
    message "$INSTALL_ROOT/etc/inittab file under superuser, then recast $SPELL." &&
    message "${DEFAULT_COLOR}" &&

    if ! query "Attempt to replace the lines automatically?" n; then
      return 1
    else
      cp $INSTALL_ROOT/etc/inittab $INSTALL_ROOT/etc/inittab-$(date +'%Y%m%d%H%M') &&
      sedit "s:/dev/tty:tty:g" "$INSTALL_ROOT/etc/inittab" &&
      message "${MESSAGE_COLOR}Updated${DEFAULT_COLOR}"
    fi
  fi
fi &&

if [[ ! -e "$INSTALL_ROOT/etc/sysconfig/hwclock" ]]; then
  config_query UTC "Should the hardware clock store time in UTC (may break systems like MS Windows)?" y
fi
