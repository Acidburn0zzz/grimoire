# There's a bug introduced by the solution of bug 8834:
# if you said "n" to $SHADOW_CONV, you ended up with the state pw/grpunconv
# left on dispelling old shadow.
# Introducing a new var $SHADOW_NEWCONV for the query to be able to re-ask
# the question.

conv_default=n &&
if [[ "$SHADOW_CONV" == "y" ]]; then conv_default=y; fi &&
# if we haven't yet an answer on the new question and the old answer was not y
if [[ -z "$SHADOW_NEWCONV" ]] && [[ $conv_default == n ]]; then
  message "Checking passwd for shadowness (there could have been an unwanted run of pwunconv/grpunconv)." &&
  if ! grep -q '^root:x:' "$INSTALL_ROOT/etc/passwd"; then
    message "Your passwd file contains password hashes, suggesting (re)conversion to shadow." &&
	 message "You can still say n to the upcoming query but make sure then to run pwconv / grpconv yourself if you want existing passwords shadowed." &&
    conv_default=y
  fi
fi &&

config_query SHADOW_NEWCONV "Attempt to convert/fix accounts (with installed shadow utils)" $conv_default &&
if [[ "$SHADOW_NEWCONV" == y ]]; then
  message "OK, checking your user and group accounts" &&
  grpck -r "$INSTALL_ROOT/etc/group" "$INSTALL_ROOT/etc/gshadow" ||
  {
    message "there are problems with group... runinng grpck 
interactively" &&
    grpck "$INSTALL_ROOT/etc/group" "$INSTALL_ROOT/etc/gshadow"
  }
  pwck -q -r "$INSTALL_ROOT/etc/passwd" "$INSTALL_ROOT/etc/shadow" ||
  {
    message "there are problems with passwd... runinng grpck 
interactively" &&
    grpck "$INSTALL_ROOT/etc/passwd" "$INSTALL_ROOT/etc/shadow"
  }
fi
# the tools give negative return even after successfully fixing stuff
true
