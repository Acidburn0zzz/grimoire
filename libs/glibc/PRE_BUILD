default_pre_build  &&

  cd      $SOURCE_DIRECTORY                  &&
  patch $SOURCE_DIRECTORY/timezone/Makefile  \
        $SCRIPT_DIRECTORY/localtime.patch    &&


#
# Remove kernel DRM headers
# Fixes Bug #15547
#
#sed -i '/^header-y += drm\//d' $GLIBC_HEADERS_DIR/include/Kbuild &&
#rm -rf $GLIBC_HEADERS_DIR/include/drm &&

#
# Now fixup the normal glibc
#
cd  $SOURCE_DIRECTORY                               &&
patch  -p0  <  $SCRIPT_DIRECTORY/Makefile.patch     &&
patch  -p1  <  $SCRIPT_DIRECTORY/as-test-x.patch &&
patch -p1 < $SPELL_DIRECTORY/gcc45.patch &&

# disabled libgd detection/building memusagestat for now until a better
# fix has been found, bug #8277
sedit  's/LIBGD=yes/LIBGD=no/'  $SOURCE_DIRECTORY/configure  &&

#
# Create the build directory
#
mk_source_dir  $SOURCE_DIRECTORY.bld &&

# fix #11832 - linking in /tmp doesn't work with grsecurity so do it elsewhere
local test_path=$SOURCE_DIRECTORY.bld/test-installation &&
mkdir $test_path &&
sed -i "s,/tmp,$test_path,g" scripts/test-installation.pl &&
sed -i 's/ot \$/ot:\n\ttouch $@\n$/' manual/Makefile &&

# CC="gcc" /usr/bin/perl scripts/test-installation.pl /usr/src/glibc-2.13.bld/
# /usr/lib/gcc/i686-pc-linux-gnu/4.4.3/../../../../i686-pc-linux-gnu/bin/ld: cannot find -lnss_test1
patch scripts/test-installation.pl < $SPELL_DIRECTORY/test-installation.pl.patch
