default_pre_build  &&

#
# Set GLIBC_HEADERS_DIR for use later
#
persistent_add  GLIBC_HEADERS_DIR                                        &&
GLIBC_HEADERS_DIR=$SOURCE_DIRECTORY/linux-headers-${HEADERS_VERSION}-${GLIBC_ARCH}  &&

#
# Set GLIBC_LIBIDN_DIR for use later; the variable was needlessly persistent
#
persistent_remove  GLIBC_LIBIDN_DIR                                      &&
local GLIBC_LIBIDN_DIR=$SOURCE_DIRECTORY/glibc-libidn-$VERSION           &&

if  [  "$GLIBC_NPTL"  =  "y"  ];  then
  cd      $SOURCE_DIRECTORY                           &&

  if [ "$GLIBC_USEIDN" = "y" ]; then
    #
    # Unpack glibc-libidn
    #
    unpack_file 4                         &&
    mv $GLIBC_LIBIDN_DIR libidn
  fi &&

  #
  # Unpack glibc-kernel-headers
  #
  unpack_file 3                         &&
  cd  $GLIBC_HEADERS_DIR/usr/include                  &&
  chmod  -R  +r  *                                    &&
  find  .  -type  d  -exec  chmod  +x  '{}'  ';'
else
  cd      $SOURCE_DIRECTORY                         &&
  #
  # Now unpack the rest of glibc fixes in the normal location
  #
  unpack_file 3                       &&
  #
  # Unpack glibc-kernel-headers
  #
  mkdir  -p  $GLIBC_HEADERS_DIR/usr/include         &&
  cd  $GLIBC_HEADERS_DIR/usr/include                &&
  unpack_file 5
fi  &&

#
# Now fixup the normal glibc
#
cd  $SOURCE_DIRECTORY                               &&
if [[ $GLIBC_NPTL == n ]]; then
  patch  -p1  <  $SCRIPT_DIRECTORY/glibcshared.patch 
fi &&
patch  -p0  <  $SCRIPT_DIRECTORY/Makefile.patch     &&
patch  -p1  <  $SCRIPT_DIRECTORY/as-test-x.patch &&

# disabled libgd detection/building memusagestat for now until a better
# fix has been found, bug #8277
sedit  's/LIBGD=yes/LIBGD=no/'  $SOURCE_DIRECTORY/configure  &&

#
# Create the build directory
#
mk_source_dir  $SOURCE_DIRECTORY.bld &&

# fix #11832 - linking in /tmp doesn't work with grsecurity so do it elsewhere
local test_path=$SOURCE_DIRECTORY.bld/test-installation &&
mkdir $test_path &&
sed -i "s,/tmp,$test_path,g" scripts/test-installation.pl

