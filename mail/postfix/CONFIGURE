persistent_add POSTFIX_PRE_EXISTING &&
persistent_add POSTFIX_FIX_MAINCF &&
persistent_add POSTFIX_VDA &&

if [[ "x$POSTFIX_VDA" == "x" ]] && spell_ok $SPELL; then
    persistent_read $SPELL VDA POSTFIX_VDA
fi &&

if [[ -f /etc/postfix/main.cf ]]; then
    POSTFIX_PRE_EXISTING="yes" &&

    message "${MESSAGE_COLOR}Pre-existing main.cf found. Doing upgrade install.${DEFAULT_COLOR}" &&
    message "${WARNING_COLOR}If you do not say yes to the next question this spell could fail to install${DEFAULT_COLOR}" &&
    message "${MESSAGE_COLOR}The spell will go through your main.cf and ensure that the man pages are" &&
    message "installed to the right place, because the postfix install program uses the" &&
    message "values from the main.cf to determine where to install things.${DEFAULT_COLOR}" &&

    config_query POSTFIX_FIX_MAINCF "Check for and fix problems in installed main.cf? (HIGHLY RECOMMENDED)" y
else
    POSTFIX_PRE_EXISTING="no" &&
    message "${MESSAGE_COLOR}No pre-existing main.cf found. Doing normal install.${DEFAULT_COLOR}"
fi &&

config_query POSTFIX_BENCH "Install smtpstone benckmarking tools?" n &&

# Config file backup
#message "${MESSAGE_COLOR}Configuration file loss may expose your system to SPAM relaying." &&
#message "You should backup and restore configuration files and reply y to the next two questions...${DEFAULT_COLOR}" &&
#config_query BACKUP "Backup config on dispel?" y &&
#config_query RESTORE "Restore config on rebuild/update?" y

# Newaliases
#message "${MESSAGE_COLOR}You should run newaliases after each aliases file update, and on first $spell cast...$}DEFAULT_COLOR}" &&
#config_query ALIAS "Run newaliases after cast?" y &&

config_query POSTFIX_VDA "Apply Virtual Delivery Agent (VDA) patch? (EXPERIMENTAL)" n
